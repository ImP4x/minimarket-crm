{% extends "base.html" %}

{% block title %}Registro de Ventas - EcoMarket{% endblock %}

{% block content %}
<div class="fade-in">
    <h1 class="section-title">Registro de Ventas</h1>
    
    <!-- Formulario para agregar productos al carrito -->
    <div class="form-card">
        <h2 class="section-title">Agregar Producto al Carrito</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="cliente">Cliente *</label>
                <select id="cliente" name="cliente" class="form-control" required>
                    <option value="">Seleccionar cliente...</option>
                    {% for c in clientes %}
                        <option value="{{ c._key }}">{{ c.nombre }} ({{ c.email or 'Sin email' }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="producto">Producto *</label>
                <select id="producto" name="producto" class="form-control">
                    <option value="">Seleccionar producto...</option>
                    {% for p in productos %}
                        <option value="{{ p._key }}" 
                                data-nombre="{{ p.nombre }}" 
                                data-precio="{{ p.precio }}" 
                                data-stock="{{ p.stock }}">
                            {{ p.nombre }} - ${{ "%.2f"|format(p.precio) }} (Stock: {{ p.stock }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="cantidad">Cantidad *</label>
                <input type="number" id="cantidad" name="cantidad" class="form-control" min="1" value="1">
            </div>
        </div>
        
        <button type="button" onclick="agregarAlCarrito()" class="btn btn-primary">
            üõí Agregar al Carrito
        </button>
    </div>

    <!-- Carrito de Compras -->
    <div id="carritoContainer" class="form-card" style="display: none;">
        <h2 class="section-title">üõí Carrito de Compras</h2>
        
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th style="text-align: center;">Cantidad</th>
                        <th style="text-align: right;">Precio Unit.</th>
                        <th style="text-align: right;">Subtotal</th>
                        <th style="text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="carritoBody">
                    <!-- Los productos se agregan din√°micamente -->
                </tbody>
            </table>
        </div>

        <div class="action-buttons">
            <button type="button" onclick="procesarVenta()" class="btn btn-success">
                ‚úÖ Procesar Venta Completa
            </button>
            <button type="button" onclick="vaciarCarrito()" class="btn btn-danger">
                üóëÔ∏è Vaciar Carrito
            </button>
        </div>
        
        <div style="text-align: right; padding: 1rem; background: var(--color-light); border-radius: var(--border-radius); margin-top: 1rem;">
            <h3 style="color: var(--color-primary); margin: 0;">
                TOTAL: <span id="totalCarrito">$0.00</span>
            </h3>
        </div>
    </div>

    <!-- Botones de navegaci√≥n -->
    <div class="action-buttons">
        <a href="{{ url_for('ventas.ver_stock') }}" class="btn btn-secondary">üì¶ Ver Stock Disponible</a>
        <a href="{{ url_for('ventas.listar_facturas_view') }}" class="btn btn-secondary">üìÑ Ver Todas las Facturas</a>
        <a href="{{ url_for('ventas.reporte_ventas') }}" class="btn btn-primary">üìä Ver Reporte de Ventas</a>
    </div>

    <div class="action-buttons">
        <a href="{{ url_for('auth.dashboard_admin') if session['usuario']['rol'] == 'administrador' else url_for('auth.dashboard_vendedor') }}"
           class="btn btn-secondary">‚Üê Volver al Panel</a>
    </div>
</div>

<script>
// Carrito de compras
let carrito = [];

function agregarAlCarrito() {
    const clienteSelect = document.getElementById('cliente');
    const productoSelect = document.getElementById('producto');
    const cantidadInput = document.getElementById('cantidad');
    
    if (!clienteSelect.value) {
        showFlash('Por favor selecciona un cliente', 'error');
        return;
    }
    
    if (!productoSelect.value) {
        showFlash('Por favor selecciona un producto', 'error');
        return;
    }
    
    const cantidad = parseInt(cantidadInput.value);
    if (cantidad <= 0) {
        showFlash('La cantidad debe ser mayor a 0', 'error');
        return;
    }
    
    const opcionSeleccionada = productoSelect.options[productoSelect.selectedIndex];
    const productoId = productoSelect.value;
    const productoNombre = opcionSeleccionada.dataset.nombre;
    const productoPrecio = parseFloat(opcionSeleccionada.dataset.precio);
    const productoStock = parseInt(opcionSeleccionada.dataset.stock);
    
    const cantidadEnCarrito = obtenerCantidadEnCarrito(productoId);
    if (cantidadEnCarrito + cantidad > productoStock) {
        showFlash(`Stock insuficiente. Disponible: ${productoStock}, En carrito: ${cantidadEnCarrito}`, 'error');
        return;
    }
    
    const productoExistente = carrito.find(item => item.id === productoId);
    
    if (productoExistente) {
        productoExistente.cantidad += cantidad;
        showFlash(`Se agregaron ${cantidad} unidades m√°s de ${productoNombre}`, 'success');
    } else {
        carrito.push({
            id: productoId,
            nombre: productoNombre,
            precio: productoPrecio,
            cantidad: cantidad,
            stock: productoStock
        });
        showFlash(`${productoNombre} agregado al carrito`, 'success');
    }
    
    cantidadInput.value = 1;
    actualizarCarrito();
}

function obtenerCantidadEnCarrito(productoId) {
    const producto = carrito.find(item => item.id === productoId);
    return producto ? producto.cantidad : 0;
}

function eliminarDelCarrito(productoId) {
    const index = carrito.findIndex(item => item.id === productoId);
    if (index > -1) {
        const productoEliminado = carrito[index];
        carrito.splice(index, 1);
        showFlash(`${productoEliminado.nombre} eliminado del carrito`, 'success');
        actualizarCarrito();
    }
}

function vaciarCarrito() {
    if (carrito.length === 0) {
        showFlash('El carrito ya est√° vac√≠o', 'error');
        return;
    }
    
    if (confirm('¬øEst√°s seguro de vaciar todo el carrito?')) {
        carrito = [];
        actualizarCarrito();
        showFlash('Carrito vaciado', 'success');
    }
}

function actualizarCarrito() {
    const carritoContainer = document.getElementById('carritoContainer');
    const carritoBody = document.getElementById('carritoBody');
    const totalCarrito = document.getElementById('totalCarrito');
    
    if (carrito.length === 0) {
        carritoContainer.style.display = 'none';
        return;
    }
    
    carritoContainer.style.display = 'block';
    carritoBody.innerHTML = '';
    
    let total = 0;
    
    carrito.forEach(item => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td><strong>${item.nombre}</strong></td>
            <td style="text-align: center;">
                <span style="background: var(--color-secondary); color: var(--color-dark); padding: 4px 12px; border-radius: 20px; font-weight: bold;">
                    ${item.cantidad}
                </span>
            </td>
            <td style="text-align: right;">$${item.precio.toFixed(2)}</td>
            <td style="text-align: right; color: var(--color-primary); font-weight: bold;">
                $${subtotal.toFixed(2)}
            </td>
            <td style="text-align: center;">
                <button onclick="eliminarDelCarrito('${item.id}')" class="btn btn-danger" style="font-size: 0.8rem; padding: 6px 12px;">
                    üóëÔ∏è
                </button>
            </td>
        `;
        carritoBody.appendChild(fila);
    });
    
    totalCarrito.textContent = `$${total.toFixed(2)}`;
}

function procesarVenta() {
    if (carrito.length === 0) {
        showFlash('El carrito est√° vac√≠o', 'error');
        return;
    }
    
    const clienteId = document.getElementById('cliente').value;
    if (!clienteId) {
        showFlash('Por favor selecciona un cliente', 'error');
        return;
    }
    
    if (!confirm(`¬øConfirmar venta de ${carrito.length} producto(s)?`)) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("ventas.ventas") }}';
    
    const inputCliente = document.createElement('input');
    inputCliente.type = 'hidden';
    inputCliente.name = 'cliente';
    inputCliente.value = clienteId;
    form.appendChild(inputCliente);
    
    const inputCarrito = document.createElement('input');
    inputCarrito.type = 'hidden';
    inputCarrito.name = 'carrito';
    inputCarrito.value = JSON.stringify(carrito);
    form.appendChild(inputCarrito);
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
